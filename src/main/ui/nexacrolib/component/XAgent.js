//==============================================================================
//
//  Copyright 2021 TOBESOFT Co., Ltd.
//  All Rights Reserved.
//
//  NOTICE: TOBESOFT permits you to use, modify, and distribute this file 
//          in accordance with the terms of the license agreement accompanying it.
//
//  Readme URL: http://www.nexacro.com/legal/license/tobesoft/ko/NexacroN-public-license-readme-1.1.html
//
//==============================================================================
if(!nexacro.XAgent){"use strict";nexacro.XAgentEventInfo=function(_a,_b,_c,_d,_e,_f){this.obj=_a;this.eventid=_b;this.statusmessage=_c;this.reason=_d;this.param=_e;this.modulename=_f;};var _pXAgentEventInfo=nexacro._createPrototype(nexacro.Event,nexacro.XAgentEventInfo);nexacro.XAgentEventInfo.prototype=_pXAgentEventInfo;_pXAgentEventInfo._type_name="XAgentEventInfo";delete _pXAgentEventInfo;_pXAgentEventInfo=null;nexacro.XAgentErrorEventInfo=function(_a,_b,_c,_d,_e){this.obj=_a;this.eventid=_b;this.errormsg=_d;this.errorcode=_c;this.data=_e;};var _pXAgentErrorEventInfo=nexacro._createPrototype(nexacro.Event,nexacro.XAgentErrorEventInfo);nexacro.XAgentErrorEventInfo.prototype=_pXAgentErrorEventInfo;_pXAgentErrorEventInfo._type_name="XAgentErrorEventInfo";delete _pXAgentErrorEventInfo;_pXAgentErrorEventInfo=null;nexacro.XAgent=function(_a,_b){nexacro._EventSinkObject.call(this,_a,_b);};var _pXAgent=nexacro._createPrototype(nexacro._EventSinkObject,nexacro.XAgent);nexacro.XAgent.prototype=_pXAgent;_pXAgent._type_name="XAgent";_pXAgent._p_port=49020;_pXAgent._p_protocol="ws";_pXAgent._p_addport=5;_pXAgent._company="TOBESOFT";_pXAgent._license="";_pXAgent._isConnect=false;_pXAgent._host="127.0.0.1";_pXAgent._basePath="XAgentWS";_pXAgent._protocolIdx=0;_pXAgent._basePort=[49020,49031];_pXAgent._currentPort=49020;_pXAgent._socket=null;_pXAgent._socket_data=[];_pXAgent._eventCallback=null;_pXAgent._svcId="";_pXAgent._module=null;_pXAgent._modulefn=null;_pXAgent._param=null;_pXAgent._event_list={"onsuccess":1,"onerror":1};_pXAgent.destroy=function(){if(this._socket){this.disconnect();}this._socket_data=null;this._socket=null;this._svcId=null;this._module=null;this._modulefn=null;this._param=null;if(this._p_parent){this._p_parent.removeChild(this.id);}nexacro._EventSinkObject.prototype.destroy.call(this);};_pXAgent.set_port=function(_a){_a=nexacro._toInt(_a);if(_a!=this._p_port){this._currentPort=this._p_port=_a;}};_pXAgent.set_protocol=function(_a){if(_a!=this._p_protocol){this._p_protocol=_a;}};_pXAgent.set_addport=function(_a){_a=nexacro._toInt(_a);if(_a!=this._p_addport){this._p_addport=_a;}};_pXAgent.connect=function(){if(this._p_protocol=="wss"){if(!this._p_port){this._p_port=this._basePort[1];}this._protocolIdx=1;this._currentPort=this._p_port;}else{if(!this._p_port){this._p_port=this._basePort[0];}this._protocolIdx=0;this._currentPort=this._p_port;}this._connect();};_pXAgent.disconnect=function(){if(this._socket){this._socket.close();this._svcId=null;this._module=null;this._modulefn=null;this._param=null;this._on_success("object_xagent_success_disconnect","disconnect",this._param);}this._on_error("object_xagent_fail_disconnect",-102,null);};_pXAgent.callMethod=function(_a,_b,_c,_d){if((!_b||_b=="")||(!_c||_c=="")||(this._isConnect==false||this._getStatus()!="OPEN")){return;}this._callService(_a,_b,_c,_d);};_pXAgent.on_fire_onsuccess=function(_a,_b,_c,_d){if(this.onsuccess&&this.onsuccess._has_handlers){var _e=new nexacro.XAgentEventInfo(this,"onsuccess",_a,_b,_c,_d);return this.onsuccess._fireEvent(this,_e);}return true;};_pXAgent.on_fire_onerror=function(_a,_b,_c){if(this.onerror&&this.onerror._has_handlers){var _d=new nexacro.XAgentErrorEventInfo(this,"onerror",_a,_b,_c);return this.onerror._fireEvent(this,_d);}};_pXAgent._on_success=function(_a,_b,_c,_d){var _e=nexacro._getErrorMessge(_a);this.on_fire_onsuccess(_e?_e:_a,_b,_c,_d);};_pXAgent._on_error=function(_a,_b,_c){var _d=nexacro._getErrorMessge(_a);this.on_fire_onerror(_b,_d,_c);};_pXAgent._callService=function(_a,_b,_c,_d){if(this._isConnect==false&&_a!="connect"){this._on_error("object_xagent_fail_socket_unconnect",-106,null);return;}var _e=this._setUUID(_a);if(_d==undefined||_d==null||_d==""){_d=[0];}var _f=this._company;var _g={};switch(_a){case "connect":_g={"connect":{"company":_f,"module":"XAgent","uid":_e}};break;case "installed":_g={"installed":{"company":_f,"module":_b,"func":"installed","uid":_e,"param":_d}};break;case "version":_g={"version":{"company":_f,"module":_b,"func":"version","uid":_e,"param":_d}};break;case "update-module":_g={"update-module":{"company":_f,"module":_b,"func":"update-module","uid":_e,"param":_d}};break;case "update-module-check":_g={"update-module-check":{"company":_f,"module":_b,"func":"update-module-check","uid":_e,"param":_d}};break;case "update-modules":_g={"update-modules":{"company":_f,"module":_b,"func":"update-moduls","uid":_e,"param":_d}};break;case "status":_g={"status":{"company":_f,"module":_b,"func":"status","uid":_e,"param":_d}};break;case "project":_g={"project":{"company":_f,"module":_b,"func":"project","uid":_e,"param":_d}};break;case "exception":_g={"exception":{"company":_f,"module":"XAgent","func":"exception","uid":_e,"param":_d}};break;case "execute":_g={"execute":{"company":_f,"module":_b,"func":"execute","uid":_e,"param":_d}};break;case "get-module-info":_g={"get-module-info":{"company":_f,"module":_b,"func":"get-module-info","uid":_e,"param":_d}};break;default:_g={"request":{"company":_f,"module":_b,"func":_c,"uid":_e,"param":_d}};break;}this._module=_b;this._svcId=_a;this._modulefn=_c;this._param=_d;this._socket.send(JSON.stringify(_g));};_pXAgent._checkPort=function(){var _a=this._p_port+this._p_addport;if(this._currentPort>=_a){this._currentPort=this._p_port;return false;}else{this._currentPort++ ;return true;}};_pXAgent._createUUID=function(){var _a=new Date().getTime();var _b=_a+"_"+"xx_yx".replace(/[xy]/g,function(_c){var _d=(nexacro._random()* 16)|0;var _e=_c=="x"?_d:(_d&0x3)|0x8;return _e.toString(16);});return _b;};_pXAgent._setUUID=function(_a){var _b=this._createUUID();this._socket_data.push({uid:_b,svc:_a});return _b;};_pXAgent._getUUID=function(_a,_b){var _c=this._socket_data;for(var _e=0;_e<_c.length;_e++ ){if(_c[_e].uid==_a){var _d=_c[_e].svc;if(_b!==true){_c[_e]=null;_c.splice(_e,1);}return {svc:_d};}}return {};};_pXAgent._bindOpenHandler=function(_a){return function(_b){if(_a._module&&_a._module.length>0){_a._callService(_a._svcId,_a._module,_a._modulefn,_a._param);}else{_a._callService("connect","XAgent","version",_a._license);}};};_pXAgent._bindMessageHandler=function(_a){return function(_b){if(_b&&_b.data){var _c=JSON.parse(_b.data);if(_c&&_c.response){var _d=_c.response;var _e=Object.keys(_d)[0];var _f={},_g="",_h=null,_i=null,_j="";if(_e){_f=_d[_e];}if(_f.company==_a._company){_g=_a._getUUID(_f.uid,(_f.evnetfn=="evnetfn")?true:undefined).svc;_h=_f.result;_i=_f.param;_j=_f.module;}switch(_e){case "connect":if(_f.company==_a._company){if(_i){_a._isConnect=true;_a._on_success("object_xagent_success_connect","connect",_i,_j);}else{_a._on_error("object_xagent_fail_check_version",-701,_b);}}break;case "installed":case "version":case "update-module":case "update-module-check":case "update-modules":case "status":case "project":case "exception":case "execute":case "get-module-info":if(_h[0]==0){_a._on_success(_h[1],_e,_i,_j);}else{_a._on_error(_h[1],_h[0],_b);}break;case "event":var _k=_f.eventid;var _l=_f.eventdata;var _i=[_k,_l];if(_h[0]==0){_a._on_success("",_e,_i,_j);}else{_a._on_error("","",_i);}break;default:if(_f.company==_a._company){if(_h[0]==0){_a._on_success(_h[1],_e,_i,_j);}else{_a._on_error(_h[1],_h[0],_i);}}else{_a._on_error("object_agent_fail_invalid_service_format",-105,_b.data);}break;}}}};};_pXAgent._bindErrorHandler=function(_a){return function(_b){_a._on_error("object_xagent_fail_communication_retry",-103,_b);};};_pXAgent._bindCloseHandler=function(_a){return function(_b){if(_a._isConnect){_a._on_error("object_xagent_fail_connection_retry",-107,null);_a._isConnect=false;}else{if(!_a._checkPort()){_a._on_error("object_xagent_fail_connection_reinstall",-104,null);}else{_a._on_error("object_xagent_fail_port_retry",-108,null);_a._socket=null;_a._connect();}}};};_pXAgent._connect=function(){if(this._getStatus()=="OPEN"&&this._module&&this._module.length>0){this._callService(this._svcId,this._module,this._modulefn,this._param);return;}var _a=this._socket=new WebSocket(this._p_protocol+"://"+this._host+":"+this._currentPort+"/"+this._basePath+"?tm="+new Date().getTime());_a.onopen=this._bindOpenHandler(this);_a.onmessage=this._bindMessageHandler(this);_a.onerror=this._bindErrorHandler(this);_a.onclose=this._bindCloseHandler(this);};_pXAgent._getStatus=function(){var _a="CONNECTING";if(!this._socket){return "CLOSED";}if(this._socket.readyState==1){_a="OPEN";}else if(this._socket.readyState==2){_a="CLOSE";}else if(this._socket.readyState==3){_a="CLOSED";}return _a;};_pXAgent._properties=[{name:"port"},{name:"protocol"},{name:"addport"}];nexacro._defineProperties(_pXAgent,_pXAgent._properties);delete _pXAgent;}